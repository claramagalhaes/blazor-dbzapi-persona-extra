@page "/"
@using System.Text.Json
@inject HttpClient Http

<h3>BlazorDbzApiPersonaExtra — Buscar personagem DBZ</h3>

<div class="mb-3" style="max-width:420px">
    <input @bind="idInput" @bind:event="oninput" placeholder="Digite o id (ex: 1)" class="form-control" />
</div>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="Buscar">Buscar</button>
</div>

@if (isLoading)
{
    <p>Carregando...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (characterFound)
{
    <div class="card" style="max-width:640px">
        <div class="card-body d-flex">
            <div>
                @if (!string.IsNullOrEmpty(imageUrl))
                {
                    <img src="@imageUrl" alt="@displayName" style="width:160px;height:160px;object-fit:contain" />
                }
                else
                {
                    <div style="width:160px;height:160px;display:flex;align-items:center;justify-content:center;border:1px solid #ddd">Sem imagem</div>
                }
            </div>
            <div style="margin-left:16px">
                <p><strong>Nome:</strong> @displayName</p>
                <p><strong>Raça:</strong> @race</p>
            </div>
        </div>
    </div>
}

@code {
    private string idInput = "";
    private bool isLoading = false;
    private string? errorMessage;
    private bool characterFound = false;

    // fields shown
    private string displayName = "";
    private string race = "";
    private string? imageUrl;

    private async Task Buscar()
    {
        errorMessage = null;
        characterFound = false;
        displayName = "";
        race = "";
        imageUrl = null;

        if (!int.TryParse(idInput?.Trim(), out var id) || id <= 0)
        {
            errorMessage = "Digite um id válido (número inteiro maior que zero).";
            return;
        }

        isLoading = true;
        try
        {
            var url = $"https://dragonball-api.com/api/characters/{id}";
            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                    errorMessage = $"Personagem com id {id} não encontrado.";
                else
                    errorMessage = $"Erro na API: {(int)response.StatusCode}";
                return;
            }

            using var stream = await response.Content.ReadAsStreamAsync();
            using var doc = await JsonDocument.ParseAsync(stream);
            var root = doc.RootElement;

            // Nome: tentar várias chaves possíveis
            displayName = TryGetString(root, "name")
                       ?? TryGetString(root, "full_name")
                       ?? TryGetString(root, "fullName")
                       ?? TryGetString(root, "character")
                       ?? "(sem nome)";

            // Raça: usar "race" ou "species"
            race = TryGetString(root, "race")
                 ?? TryGetString(root, "species")
                 ?? "(desconhecida)";

            // Imagem: tentar várias chaves comuns
            imageUrl = TryGetString(root, "image")
                    ?? TryGetString(root, "imageUrl")
                    ?? TryGetString(root, "image_url")
                    ?? TryGetString(root, "thumbnail")
                    ?? TryGetFromNested(root, "images", "jpg")
                    ?? TryGetFromNested(root, "images", "image")
                    ?? null;

            characterFound = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Ocorreu um erro: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private static string? TryGetString(JsonElement el, string propName)
    {
        if (el.TryGetProperty(propName, out var v) && v.ValueKind == JsonValueKind.String)
            return v.GetString();
        return null;
    }

    private static string? TryGetFromNested(JsonElement el, string parent, string child)
    {
        if (el.TryGetProperty(parent, out var p) && p.ValueKind == JsonValueKind.Object)
        {
            if (p.TryGetProperty(child, out var c) && c.ValueKind == JsonValueKind.String)
                return c.GetString();
        }
        return null;
    }
}
